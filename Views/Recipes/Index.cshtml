@model TerrariaDB.ViewModels.Terraria.Recipe.RecipeIndexViewModel

@{
    ViewData["Title"] = "Recipes";

    var currentResultItem = Context.Request.Query["resultItem"].ToString();
    var currentIngredient1 = Context.Request.Query["ingredient1"].ToString();
    var currentIngredient2 = Context.Request.Query["ingredient2"].ToString();
    var currentCraftingStation = Context.Request.Query["craftingStation"].ToString();
}

<h1>Recipes</h1>

<div>
    <a asp-action="Index" asp-controller="Home">Back</a>
    @if (User.IsInRole("Admin"))
    {
        <a asp-action="Create">Create</a>
    }
</div>

<div>
    <form id="filterForm" method="get" action="@Url.Action("Index")">
        <table>
            <thead>
                <tr>
                    <th>Result Item</th>
                    <th>Ingredients</th>
                    <th>Crafting Station</th>
                    <th>
                        <a href="@Url.Action("Index")" role="button">Clear Filters</a>
                    </th>
                </tr>
                <tr>
                    <td>
                        <div style="display: flex; flex-direction: row;">
                            <select name="resultItem" asp-items="Model.ResultItemFilterOptions" onchange="this.form.submit()">
                                <option value="">All</option>
                            </select>
                        </div>
                    </td>
                    <td>
                        <div style="display: flex; flex-direction: row;">
                            <select name="ingredient1" asp-items="Model.IngredientFilterOptions" onchange="this.form.submit()">
                                <option value="">All</option>
                            </select>
                            <select name="ingredient2" asp-items="Model.IngredientFilterOptions" onchange="this.form.submit()">
                                <option value="">All</option>
                            </select>
                        </div>
                    </td>
                    <td>
                        <select name="craftingStation" asp-items="Model.CraftingStationFilterOptions" onchange="this.form.submit()">
                            <option value="">All</option>
                        </select>
                    </td>
                    <td></td>
                </tr>
            </thead>
            <tbody>
                @foreach (var recipe in Model.Recipes)
                {
                    <tr>
                        <td>
                            <div style="display: flex; flex-direction: row;">
                                <div style="display: flex; flex-direction: column;">
                                    <img src="@recipe.ResultItem.Sprite" alt="@recipe.ResultItem.Name" />
                                    <span>@recipe.ResultItem.Name</span>
                                    <span>@recipe.ResultItemQuantity</span>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: row;">
                                @foreach (var ingredient in recipe.Ingredients)
                                {
                                    <div style="display: flex; flex-direction: column;">
                                        <img src="@ingredient.Sprite" alt="@ingredient.Name" />
                                        <span>@ingredient.Name</span>
                                        <span>@ingredient.Quantity</span>
                                    </div>
                                }
                            </div>
                        </td>
                        <td>
                            @if (recipe.CraftingStation != null)
                            {
                                <div style="display: flex; flex-direction: column;">
                                    <img src="@recipe.CraftingStation.Sprite" alt="@recipe.CraftingStation.Name" />
                                    <span>@recipe.CraftingStation.Name</span>
                                </div>
                            }
                        </td>
                        <td>
                            <div style="display: flex; flex-direction: row;">
                                <a asp-action="Details" asp-route-id="@recipe.Id">Details</a>
                                @if (User.IsInRole("Admin"))
                                {
                                    <a asp-action="Edit" asp-route-id="@recipe.Id">Edit</a>
                                    <a asp-action="Delete" asp-route-id="@recipe.Id">Delete</a>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);

        if (urlParams.toString() === '') {
            return;
        }

        const selects = document.querySelectorAll('#filterForm select');
        selects.forEach(select => {
            const paramValue = urlParams.get(select.name);
            if (paramValue) {
                Array.from(select.options).forEach(option => {
                    if (option.value === paramValue) {
                        option.selected = true;
                    }
                });
            } else {
                select.value = '';
            }
        });
    });
</script>
